<!DOCTYPE html>

<head>
   <link rel="stylesheet" href="/stylesheets/myCss.css">
   <title>My webpage</title>
   
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
   
   <script>
      function signOut() {
         $.get("/signOut", function(data, status){
            if(data.success == true) {
               window.location = 'home.html';
            }
            else if(data.success == false) {
               console.log('Error signing out: ' + data.err);
            }
            else {
               alert("Got unexepected error: " + data);
            }
         });
      }
   
      function setBackgroundSize() {
         var load = true;
         if(load) {
            
            var w = window.innerWidth;
            var h = window.innerHeight;
            var size = w + "px " + h + "px";
            var body = document.getElementById('body');
            body.style.backgroundSize = "cover";
            body.style.backgroundImage = "url(/images/background.jpg)";
         }
      }
      
      function purchase(data) {
         console.log("Purchasing gift");
         var shopNumber = data.id;
         console.log("Gift number: " + shopNumber);
         var json = {shopNumber: shopNumber};
         $.post("/purchase", json, function(data1, status) {
            console.log(data1);
            if(data1.success == true) {
               document.getElementById("userBells").innerHTML = data1.bells;
               document.getElementById("shopItem" + shopNumber).remove();
               console.log("num shop items: " + data1.numShop);
               if(data1.numGifts == 0)
                  document.getElementById("shopStatus").innerHTML = "You bought out the store. Wow.";
            }
            else {
               console.log("Error purchasing item: " + data1.err);
            }
         });
      }
      
      function redeemGift(data) {
         console.log("Redeeming gift");
         var giftNumber = data.id;
         console.log("Gift number: " + giftNumber);
         var json = {giftNumber: giftNumber};
         $.post("/redeem", json, function(data1, status) {
            if(data1.success == true) {
               console.log(data1);
               document.getElementById("gift" + giftNumber).remove();
               console.log("num gifts: " + data1.numGifts);
               document.getElementById('userBells').innerHTML = data1.bells;
               if(data1.numGifts == 0)
                  document.getElementById("giftStatus").innerHTML = "You are out of daily gifts";
            }
            else {
               console.log("Error redeeming item: " + data1.err);
            }
         });
      }
      
      function showGift(id, numGift) {
         giftStatus = document.getElementById("giftStatus");
         var gifts = document.getElementById("gifts");
         console.log("Showing item with id: " + id);
         $.get("/getGift?id=" + id, function(data, status) {
            if(data.success == false)
               console.log("Error displaying gift: " + data.err);
            else {
               console.log(data.id);
               var color;
               var rarity;
               if(data.rarity == 0) {
                  color = "green";
                  rarity = "common";
               }
               else if(data.rarity == 1) {
                  color = "blue";
                  rarity = "uncommon";
               }
               else if(data.rarity == 2) {
                  color = "purple";
                  rarity = "rare";
               }
               else if(data.rarity == 3) {
                  color = "orange";
                  rarity = "ultra rare";
               }
               gifts.innerHTML += "<div style='background-color: " + color + "' id='gift" + numGift + "' class='gift'></div>";
               var giftDiv = document.getElementById('gift' + numGift);
               
               if(data.set == null) {//bells
                  giftDiv.innerHTML = "<header style='text-align: center; font-style: 25px; color: yellow'>" + data.name + "</header>";
                  giftDiv.innerHTML += "<img class='giftImg' style='width: 75%; height: 75%' src='" + data.imgUrl + "'><br>";
                  giftDiv.innerHTML += "<button type='button' class='redeem' id='" + numGift + "' onclick='redeemGift(this)'>Redeem " + data.sellPrice + " bells</button>";
               } else {
                  giftDiv.innerHTML = "<header style='text-align: center; font-style: 25px; color: yellow'>" + data.name + "</header>";
                  giftDiv.innerHTML += "<img class='giftImg' src='" + data.imgUrl + "'><br>";
                  if(data.set != undefined && data.set != 'null' && data.set != null)
                     giftDiv.innerHTML += "<header style='font-weight: bold'>Set: <span style='position: absolute; right:16px; font-weight: none'>" + data.set + "</span></header>";
                  giftDiv.innerHTML += "<header style='font-weight: bold'>Buy price: <span style='position: absolute; right:16px; font-weight: none'>" + data.buyPrice + " bells</span></header>";
                  giftDiv.innerHTML += "<header style='font-weight: bold'>Sell price: <span style='position: absolute; right:16px; font-weight: none'>" + data.sellPrice + " bells</span></header>";
                  giftDiv.innerHTML += "<button type='button' class='redeem' id='" + numGift + "' onclick='redeemGift(this)'>Redeem item</button>";
               }
            }
         });
      }
      
      function showShopItem(id, numShop) {
         giftStatus = document.getElementById("shopStatus");
         var gifts = document.getElementById("shopItems");
         console.log("Showing item with id: " + id);
         $.get("/getGift?id=" + id, function(data, status) {
            if(data.success == false)
               console.log("Error displaying store item: " + data.err);
            else {
               console.log(data.id);
               var color;
               var rarity;
               if(data.rarity == 0) {
                  color = "green";
                  rarity = "common";
               }
               else if(data.rarity == 1) {
                  color = "blue";
                  rarity = "uncommon";
               }
               else if(data.rarity == 2) {
                  color = "purple";
                  rarity = "rare";
               }
               else if(data.rarity == 3) {
                  color = "orange";
                  rarity = "ultra rare";
               }
               gifts.innerHTML += "<div style='background-color: " + color + "' id='shopItem" + numShop + "' class='gift'></div>";
               var shopItemDiv = document.getElementById('shopItem' + numShop);
               
               shopItemDiv.innerHTML = "<header style='text-align: center; font-style: 25px; color: yellow'>" + data.name + "</header>";
               shopItemDiv.innerHTML += "<img class='giftImg' src='" + data.imgUrl + "'><br>";
               if(data.set != undefined && data.set != 'null' && data.set != null)
                  shopItemDiv.innerHTML += "<header style='font-weight: bold'>Set: <span style='position: absolute; right:16px; font-weight: none'>" + data.set + "</span></header>";
               shopItemDiv.innerHTML += "<button type='button' class='redeem' id='" + numShop + "' onclick='purchase(this)'>Purchase item for " + data.buyPrice + " bells</button>";
            
            }
         });
      }
      
      function drawPage() {
         var right = document.getElementById("rightSign");
         var gifts = document.getElementById("gifts");
         var giftStatus = document.getElementById("giftStatus");
         var shopStatus = document.getElementById("shopStatus");
         
         $.get("/getSession", function(data, status) {
            if(data.success == false) {
               console.log("Error getting user session: " + data.err);
               right.innerHTML = "<header class='promptLogin'>You are not logged in<br><a href='login.html' class='promptLogin' style='color: white'>Login</a></header>";
               giftStatus.innerHTML = "Log in to view your daily gift and shop items";
               document.getElementById("outerDivShop").style.backgroundColor = "rgb(255, 255, 255, 0)";
               //shopStatus.innerHTML = "Log in to view your daily store items";
            }
            else {
               right.innerHTML = "<header class='promptLogin welcome'>Welcome " + data.username + "!<br><a href='javascript:void(0);' onclick='signOut()' class='promptLogin' style='color: gray'>Logout</a><br><span id='userBells'>" + data.bells + "</span> bells<br><a href='inventory.html' class='promptLogin' style='color: gray'>View inventory</a></header>";
               if(data.numGifts > 0)
                  giftStatus.innerHTML = "Loading gifts...<hr style='margin-left: 16px; margin-right: 16px'>";
               if(data.numShop > 0)
                  shopStatus.innerHTML = "Loading shop items...<hr style='margin-left: 16px; margin-right: 16px'>";
               if(data.numGifts > 0) {
                  if(data.item0 != -1) {
                     showGift(data.item0, 0);
                  }
                  if(data.item1 != -1) {
                     showGift(data.item1, 1);
                  }
                  if(data.item2 != -1) {
                     showGift(data.item2, 2);
                  }
                  if(data.item3 != -1) {
                     showGift(data.item3, 3);
                  }
                  giftStatus.innerHTML = "Your free gifts for today!<hr style='margin-left: 16px; margin-right: 16px'>";
               }
               else
                  giftStatus.innerHTML = "You are out of daily gifts";
               if(data.numShop > 0) {
                  if(data.shop0 != -1) {
                     showShopItem(data.shop0, 0);
                  }
                  if(data.shop1 != -1) {
                     showShopItem(data.shop1, 1);
                  }
                  if(data.shop2 != -1) {
                     showShopItem(data.shop2, 2);
                  }
                  if(data.shop3 != -1) {
                     showShopItem(data.shop3, 3);
                  }
                  if(data.shop4 != -1) {
                     showShopItem(data.shop4, 4);
                  }
                  if(data.shop5 != -1) {
                     showShopItem(data.shop5, 5);
                  }
                  if(data.shop6 != -1) {
                     showShopItem(data.shop6, 6);
                  }
                  if(data.shop7 != -1) {
                     showShopItem(data.shop7, 7);
                  }
                  if(data.shop8 != -1) {
                     showShopItem(data.shop8, 8);
                  }
                  if(data.shop9 != -1) {
                     showShopItem(data.shop9, 9);
                  }
                  gifts.innerHTML += "<br>";
                  shopStatus.innerHTML = "Your daily shop items<hr style='margin-left: 16px; margin-right: 16px'>";
               }
               else
                  shopStatus.innerHTML = "You bought out the store. Wow";
            }
         });
      }
      
  
   </script>
   
</head>

<body onload="setBackgroundSize()" id="body">

   <div style="height: 250px"> <!-- Header --->
      <div id="leftSign" class="leftSign">
         <header class="leftSignText">Trading<br>Outpost</header>
      </div>
      <div id="rightSign" class="rightSign">
         
   </div></div>
   
   
   
   <!-- Two divs to wrap content and center it --->
   <div id="outerDivGifts" class="outerGifts" style="text-align: center"><header class='status' id='giftStatus'></header><div id="gifts" class="gifts">
      
   </div></div>
   
   <div id="outerDivShop" class="outerGifts" style="text-align: center; width: 500px"><header class='status' id='shopStatus'></header><div id="shopItems" class="gifts">
      
   </div></div>
   
   <script type="text/javascript">
      drawPage();
   </script>
   
</body>
</html>